"use strict";var Ico={Base:{},Normaliser:{},SparkLine:{},SparkBar:{},BaseGraph:{},LineGraph:{},AreaGraph:{},StackGraph:{},BarGraph:{},HorizontalBarGraph:{}};Ico.Base=Class.create({normaliseData:function(b){return $A(b).collect(function(a){return this.normalise(a)}.bind(this))},deepCopy:function(a){var b,i,len;if(Object.prototype.toString.call(a)==='[object Array]'){b=[];i=0;len=a.length;for(i;i<len;i++){b[i]=arguments.callee(a[i])}return b}if(typeof a==='object'){b={};for(i in a){b[i]=arguments.callee(a[i])}return b}return a}});Ico.Normaliser=Class.create({initialize:function(a,b){this.options={start_value:null};Object.extend(this.options,b||{});this.min=a.min();this.max=a.max();this.standard_deviation=a.standard_deviation();this.range=0;this.step=this.labelStep(this.max-this.min);this.start_value=this.calculateStart();this.process()},calculateStart:function(){var a=this.options.start_value!==null&&this.min>=0?this.options.start_value:this.min,start_value=this.round(a,1);if(this.min>0&&start_value>this.min){return 0}return start_value},round:function(a,b){var c=a,multiplier;b=b||1;if(this.standard_deviation>0.1){multiplier=Math.pow(10,-b);c=Math.round(a*multiplier)/multiplier;if(c>this.min){return this.round(a-this.step)}}return c},process:function(){this.range=this.max-this.start_value;this.step=this.labelStep(this.range);if(this.range/this.step>15){this.step*=3}},labelStep:function(a){return Math.pow(10,(Math.log(a)/Math.LN10).round()-1)}});Ico.BaseGraph=Class.create(Ico.Base,{initialize:function(b,c,d){this.element=b;this.data_sets=Object.isArray(c)?new Hash({one:c}):$H(c);if(this.chartDefaults().stacked===true){this.real_data=this.deepCopy(this.data_sets);this.stackData(this.data_sets)}this.flat_data=this.data_sets.collect(function(a){return a[1]}).flatten();this.normaliser=new Ico.Normaliser(this.flat_data,this.normaliserOptions());this.label_step=this.normaliser.step;this.range=this.normaliser.range;this.start_value=this.normaliser.start_value;this.data_size=this.longestDataSetLength();if(d&&d.colour){d.colours={};this.data_sets.keys().each(function(a){d.colours[a]=d.colour})}this.options={width:parseInt(b.getStyle('width'),10),height:parseInt(b.getStyle('height'),10),labels:$A($R(1,this.data_size)),plot_padding:10,font_size:10,show_horizontal_labels:true,show_vertical_labels:true,vertical_label_unit:false,colours:this.makeRandomColours(),background_colour:b.getStyle('backgroundColor'),label_colour:'#000',grid_colour:'#ccc',markers:false,marker_size:5,meanline:false,y_padding_top:20,draw_axis:true,stacked_fill:false,datalabels:'',start_at_zero:true,bargraph_lastcolour:false,hover_colour:'',watermark:false,watermark_orientation:false,horizontal_rounded:false,hide_empty_label_grid:false,left_padding:false};Object.extend(this.options,this.chartDefaults()||{});Object.extend(this.options,d||{});this.x_padding_left=10+this.paddingLeftOffset();this.x_padding_left+=this.options.vertical_label_unit?6:0;this.x_padding_left=this.options.left_padding?this.options.left_padding:this.x_padding_left;this.x_padding_right=20;this.x_padding=this.x_padding_left+this.x_padding_right;this.y_padding_top=this.options.y_padding_top;this.y_padding_bottom=20+this.paddingBottomOffset();this.y_padding=this.y_padding_top+this.y_padding_bottom;this.graph_width=this.options.width-this.x_padding;this.graph_height=this.options.height-this.y_padding;this.step=this.calculateStep();this.y_label_count=(this.range/this.label_step).round();if((this.normaliser.min+(this.y_label_count*this.normaliser.step))<this.normaliser.max){this.y_label_count+=1}this.value_labels=this.makeValueLabels(this.y_label_count);this.top_value=this.value_labels.last();this.grid_start_offset=-1;this.paper=new Raphael(this.element,this.options.width,this.options.height);this.background=this.paper.rect(this.x_padding_left,this.y_padding_top,this.graph_width,this.graph_height);this.background.attr({fill:this.options.background_colour,stroke:'none'});if(this.options.meanline===true){this.options.meanline={'stroke-width':'2px',stroke:'#BBBBBB'}}this.globalHoverSet=this.paper.set();this.globalBlockSet=this.paper.set();this.setChartSpecificOptions();this.draw();this.globalHoverSet.toFront();this.globalBlockSet.toFront()},normaliserOptions:function(){return{graph_height:parseInt(this.element.getStyle('height'),10)}},chartDefaults:function(){},drawPlot:function(a,b,x,y,c,d,e,f,g){},calculateStep:function(){},getMousePos:function(e){var a=0,posy=0,mousepos;if(!e){e=window.event}if(e.pageX||e.pageY){a=e.pageX;posy=e.pageY}else if(e.clientX||e.clientY){a=e.clientX+document.body.scrollLeft-document.documentElement.scrollLeft;posy=e.clientY+document.body.scrollTop-document.documentElement.scrollTop}mousepos={x:a,y:posy};return mousepos},makeRandomColours:function(b){var c={};this.data_sets.each(function(a){c[a[0]]=Raphael.hsb2rgb(Math.random(),1,0.75).hex});return c},longestDataSetLength:function(){var b=0;this.data_sets.each(function(a){b=a[1].length>b?a[1].length:b});return b},roundValue:function(a,b){var c=Math.pow(10,b);a*=c;a=Math.round(a)/c;return a},roundValues:function(b,c){return $A(b).collect(function(a){return this.roundValue(a,c)}.bind(this))},paddingLeftOffset:function(){if(this.options.show_vertical_labels){var c=this.flat_data,longest_label_length;c=this.roundValues(c,2);longest_label_length=$A(c).sort(function(a,b){return a.toString().length<b.toString().length}).first().toString().length;longest_label_length=longest_label_length>2?longest_label_length-1:longest_label_length;return longest_label_length*this.options.font_size}else{return 0}},paddingBottomOffset:function(){return this.options.font_size},normalise:function(a){var b=this.start_value===0?this.top_value:this.range;return((a/b)*this.graph_height)},draw:function(){if(this.options.grid){this.drawGrid()}if(this.options.watermark){this.drawWatermark()}if(this.options.meanline){this.drawMeanLine(this.normaliseData(this.flat_data))}if(this.options.draw_axis){this.drawAxis()}if(this.options.show_vertical_labels){this.drawVerticalLabels()}if(this.options.show_horizontal_labels){this.drawHorizontalLabels()}if(!this.options.watermark){this.drawLinesInit(this)}if(this.start_value!==0){this.drawFocusHint()}},drawLinesInit:function(c){c.data_sets.each(function(a,b){c.drawLines(a[0],c.options.colours[a[0]],c.normaliseData(a[1]),c.options.datalabels[a[0]],c.element,b)}.bind(c))},drawWatermark:function(){var b=this.options.watermark,watermarkimg=new Image(),thisgraph=this;watermarkimg.onload=function(){var a,bottom,image;if(thisgraph.options.watermark_orientation==="middle"){a=(thisgraph.graph_width-watermarkimg.width)/2+thisgraph.x_padding_left;bottom=(thisgraph.graph_height-watermarkimg.height)/2+thisgraph.y_padding_top}else{a=thisgraph.graph_width-watermarkimg.width+thisgraph.x_padding_left-2;bottom=thisgraph.graph_height-watermarkimg.height+thisgraph.y_padding_top-2}image=thisgraph.paper.image(watermarkimg.src,a,bottom,watermarkimg.width,watermarkimg.height).attr({'opacity':'0.4'});thisgraph.drawLinesInit(thisgraph,thisgraph.data);if(thisgraph.options.stacked_fill){image.toFront()}};watermarkimg.src=b.src||b},drawGrid:function(){var a=this.paper.path().attr({stroke:this.options.grid_colour}),y,x,x_labels;if(this.options.show_vertical_labels){y=this.graph_height+this.y_padding_top;for(var i=0;i<this.y_label_count+1;i++){if((this.options.horizontalbar_grid&&i===this.y_label_count)||!this.options.horizontalbar_grid){a.moveTo(this.x_padding_left-0.5,parseInt(y,10)+0.5);a.lineTo(this.x_padding_left+this.graph_width-0.5,parseInt(y,10)+0.5)}y=y-(this.graph_height/this.y_label_count)}}if(this.options.show_horizontal_labels){x=this.x_padding_left+this.options.plot_padding+this.grid_start_offset;x_labels=this.options.labels.length;if(!this.bar_padding){for(var i=0;i<x_labels;i++){if((this.options.hide_empty_label_grid===true&&this.options.labels[i]!=="")||this.options.hide_empty_label_grid===false){a.moveTo(parseInt(x,10),this.y_padding_top);a.lineTo(parseInt(x,10),this.y_padding_top+this.graph_height)}x=x+this.step}}if(this.bar_padding){a.moveTo(parseInt(this.x_padding_left,10)-0.5,this.y_padding_top);a.lineTo(parseInt(this.x_padding_left,10)-0.5,this.y_padding_top+this.graph_height);a.moveTo(parseInt(this.x_padding_left+this.graph_width,10)-0.5,this.y_padding_top);a.lineTo(parseInt(this.x_padding_left+this.graph_width,10)-0.5,this.y_padding_top+this.graph_height)}}},drawLines:function(c,d,f,g,h,i){var j=this.calculateCoords(f),y_offset=(this.graph_height+this.y_padding_top),cursor,odd_horizontal_offset,rel_opacity;if(this.options.start_at_zero===false){odd_horizontal_offset=0;$A(j).each(function(a,b){if(a[1]===y_offset){odd_horizontal_offset++}});this.options.odd_horizontal_offset=odd_horizontal_offset;if(this.options.odd_horizontal_offset>1){j.splice(0,this.options.odd_horizontal_offset)}}if(this.options.stacked_fill||this.options.area){if(this.options.area){rel_opacity=this.data_sets.collect(function(a){return a.length}).length;cursor=this.paper.path().attr({stroke:d,fill:d,'stroke-width':'0','fill-opacity':1.5/rel_opacity})}else{cursor=this.paper.path().attr({stroke:d,fill:d,'stroke-width':'0'})}j.unshift([j[0][0],y_offset]);j.push([j[j.length-1][0],y_offset])}else{cursor=this.paper.path().attr({stroke:d,'stroke-width':'5px'})}if(this.options.datalabels){var k=(this.options.stacked_fill||this.options.area)?"fill":"stroke",hover_colour=this.options.hover_colour||d;var l=this.paper.set(),textpadding=4,text=this.paper.text(cursor.attrs.x,cursor.attrs.y-(this.options.font_size*1.5)-textpadding,g);text.attr({'font-size':this.options.font_size,fill:this.options.background_colour,opacity:1});var m=text.getBBox(),roundRect=this.paper.rect(text.attrs.x-(m.width/2)-textpadding,text.attrs.y-(m.height/2)-textpadding,m.width+(textpadding*2),m.height+(textpadding*2),textpadding*1.5);roundRect.attr({fill:this.options.label_colour,opacity:1});text.toFront();l.push(roundRect,text).attr({opacity:0}).toFront();this.checkHoverPos({rect:roundRect,set:l});this.globalHoverSet.push(l);cursor.node.onmouseover=function(e){if(k==="fill"){cursor.attr({fill:hover_colour,stroke:hover_colour})}else{cursor.attr({stroke:hover_colour})}var b=this.getMousePos(e);l[0].attr({x:b.x-(m.width/2)-textpadding-h.offsetLeft,y:b.y-(m.height/2)-(this.options.font_size*1.5)-textpadding-h.offsetTop,opacity:1});l[1].attr({x:b.x-h.offsetLeft,y:b.y-(this.options.font_size*1.5)-h.offsetTop,opacity:1});cursor.node.onmousemove=function(e){var a=this.getMousePos(e);l[0].attr({x:a.x-(m.width/2)-textpadding-h.offsetLeft,y:a.y-(m.height/2)-(this.options.font_size*1.5)-textpadding-h.offsetTop,opacity:1});l[1].attr({x:a.x-h.offsetLeft,y:a.y-(this.options.font_size*1.5)-h.offsetTop,opacity:1});this.checkHoverPos(roundRect,l)}.bind(this)}.bind(this);cursor.node.onmouseout=function(){if(k==="fill"){cursor.attr({fill:d,stroke:d})}else{cursor.attr({stroke:d})}l.attr({opacity:0})}}$A(j).each(function(a,b){var x=a[0],y=a[1];this.drawPlot(b,cursor,x,y,d,j,g,h,i)}.bind(this))},calculateCoords:function(b){var x=this.x_padding_left+this.options.plot_padding-this.step,y_offset=(this.graph_height+this.y_padding_top)+this.normalise(this.start_value);return $A(b).collect(function(a){var y=y_offset-a;x=x+this.step;return[x,y]}.bind(this))},drawFocusHint:function(){var a=5,x=this.x_padding_left+(a/2)-1,y=this.options.height-this.y_padding_bottom,cursor=this.paper.path().attr({stroke:this.options.label_colour,'stroke-width':2});cursor.moveTo(x,y);cursor.lineTo(x-a,y-a);cursor.moveTo(x,y-a);cursor.lineTo(x-a,y-(a*2))},drawMeanLine:function(c){var d=this.paper.path().attr({stroke:this.options.meanline}),offset=$A(c).inject(0,function(a,b){return b+a})/c.length;d.moveTo(this.x_padding_left-1,this.options.height-this.y_padding_bottom-offset);d.lineTo(this.graph_width+this.x_padding_left,this.options.height-this.y_padding_bottom-offset)},drawAxis:function(){var a=this.paper.path().attr({stroke:this.options.label_colour});a.moveTo(parseInt(this.x_padding_left,10)-0.5,this.options.height-parseInt(this.y_padding_bottom,10)+0.5);a.lineTo(parseInt(this.graph_width+this.x_padding_left,10)-0.5,this.options.height-parseInt(this.y_padding_bottom,10)+0.5);a.moveTo(parseInt(this.x_padding_left,10)-0.5,parseInt(this.options.height-this.y_padding_bottom,10)+0.5);a.lineTo(parseInt(this.x_padding_left,10)-0.5,parseInt(this.y_padding_top,10))},makeValueLabels:function(a){var b=this.label_step,label=this.start_value,labels=[];for(var i=0;i<a;i++){label=this.roundValue((label+b),3);labels.push(label)}return labels},drawMarkers:function(b,c,d,e,f,g){function x_offset(a){return a*c[0]}function y_offset(a){return a*c[1]}var x=parseInt(this.x_padding_left,10)-0.5+x_offset(e),y=this.options.height-this.y_padding_bottom+y_offset(e),cursor=this.paper.path().attr({stroke:this.options.label_colour}),font_options={"font":this.options.font_size+'px "Arial"',stroke:"none",fill:this.options.label_colour};Object.extend(font_options,g||{});b.each(function(a){if(this.options.draw_axis&&((this.options.hide_empty_label_grid===true&&a!=="")||this.options.hide_empty_label_grid===false)){cursor.moveTo(parseInt(x,10),parseInt(y,10)+0.5);cursor.lineTo(parseInt(x,10)+y_offset(5),parseInt(y,10)+0.5+x_offset(5))}this.paper.text(x+f[0],y-2-f[1],a).attr(font_options).toFront();x=x+x_offset(d);y=y+y_offset(d)}.bind(this))},drawVerticalLabels:function(){var a=this.graph_height/this.y_label_count;var b=this.options.vertical_label_unit?" "+this.options.vertical_label_unit:"";for(var i=0;i<this.value_labels.length;i++){this.value_labels[i]+=b}this.drawMarkers(this.value_labels,[0,-1],a,a,[-8,-2],{"text-anchor":'end'})},drawHorizontalLabels:function(){this.drawMarkers(this.options.labels,[1,0],this.step,this.options.plot_padding,[0,(this.options.font_size+7)*-1])},checkHoverPos:function(a){var b,rect,rectsize,set,marker,nib,textpadding;if(a.rect){rect=a.rect;rectsize=rect.getBBox()}if(a.set){set=a.set}if(a.marker){marker=a.marker}if(a.nib){nib=a.nib}if(a.textpadding){textpadding=a.textpadding}if(rect&&set){if(rect.attrs.y<0){if(nib&&marker){set.translate(0,set.getBBox().height+(textpadding*2));marker.translate(0,-set.getBBox().height-(textpadding*2));nib.translate(0,-rectsize.height-textpadding-1).scale(1,-1)}else{b=rect.attrs.y;set.translate(0,1+(b*-1))}}if((rect.attrs.y+rectsize.height)>this.options.height){b=(rect.attrs.y+rectsize.height)-this.options.height;set.translate(0,(b*-1)-1);if(marker){marker.translate(0,b+1)}}if(rect.attrs.x<0){b=rect.attrs.x;set.translate((b*-1)+1,0);if(nib){nib.translate(b-1,0)}if(marker){marker.translate(b-1,0)}}if((rect.attrs.x+rectsize.width)>this.options.width){b=(rect.attrs.x+rectsize.width)-this.options.width;set.translate((b*-1)-1,0);if(nib){nib.translate(b+1,0)}if(marker){marker.translate(b+1,0)}}}}});Array.prototype.sum=function(){for(var i=0,sum=0;i<this.length;sum+=this[i++]){}return sum};if(typeof Array.prototype.max==='undefined'){Array.prototype.max=function(){return Math.max.apply({},this)}}if(typeof Array.prototype.min==='undefined'){Array.prototype.min=function(){return Math.min.apply({},this)}}Array.prototype.mean=function(){return this.sum()/this.length};Array.prototype.variance=function(){var a=this.mean(),variance=0;for(var i=0;i<this.length;i++){variance+=Math.pow(this[i]-a,2)}return variance/(this.length-1)};Array.prototype.standard_deviation=function(){return Math.sqrt(this.variance())};Raphael.el.isAbsolute=true;Raphael.el.absolutely=function(){this.isAbsolute=1;return this};Raphael.el.relatively=function(){this.isAbsolute=0;return this};Raphael.el.moveTo=function(x,y){this._last={x:x,y:y};return this.attr({path:this.attrs.path+["m","M"][+this.isAbsolute]+parseFloat(x)+" "+parseFloat(y)})};Raphael.el.lineTo=function(x,y){this._last={x:x,y:y};return this.attr({path:this.attrs.path+["l","L"][+this.isAbsolute]+parseFloat(x)+" "+parseFloat(y)})};Raphael.el.cplineTo=function(x,y,w){this.attr({path:this.attrs.path+["C",this._last.x+w,this._last.y,x-w,y,x,y]});this._last={x:x,y:y};return this};Raphael.el.andClose=function(){return this.attr({path:this.attrs.path+"z"})};Ico.LineGraph=Class.create(Ico.BaseGraph,{chartDefaults:function(){return{plot_padding:10,stacked_fill:false}},setChartSpecificOptions:function(){if(typeof this.options.curve_amount==='undefined'){this.options.curve_amount=10}},calculateStep:function(){return(this.graph_width-(this.options.plot_padding*2))/(this.data_size-1)},startPlot:function(a,x,y,b){a.moveTo(x,y)},drawGraphMarkers:function(a,x,y,b,c,d){var f=this.paper.circle(x,y,this.options.marker_size),old_marker_size=this.options.marker_size,new_marker_size;f.attr({'stroke-width':'1px',stroke:this.options.background_colour,fill:b});f.node.onmouseover=function(e){new_marker_size=parseInt(1.7*old_marker_size,10);f.animate({r:new_marker_size},200)}.bind(this);f.node.onmouseout=function(){f.animate({r:old_marker_size},200)}},drawGraphValueMarkers:function(b,x,y,c,d,f,g){if(this.options.odd_horizontal_offset>1){b+=this.options.odd_horizontal_offset}b-=this.options.stacked?1:0;var h=this.options.stacked?this.real_data:this.data_sets,currentvalue=h.collect(function(a){return a[1][b]})[g],vertical_label_unit=this.options.vertical_label_unit||"";if(currentvalue){currentvalue=currentvalue.toString().split('.');if(currentvalue[1]){currentvalue[1]=currentvalue[1].truncate(3,'')}}if(!this.options.stacked||(this.options.stacked&&b!==-1&&typeof(currentvalue)!=="undefined")){var i=x-(this.step/2),recty=this.options.stacked?y-(this.graph_height/18):y-(this.graph_height/6),rectw=this.step,recth=this.options.stacked?this.graph_height/9:this.graph_height/3,circle=this.paper.circle(x,y,this.options.marker_size),block=this.paper.rect(i,recty,rectw,recth);circle.attr({'stroke-width':'1px',stroke:this.options.background_colour,fill:c,opacity:0});block.attr({fill:c,'stroke-width':0,stroke:c,opacity:0}).toFront();if(this.options.datalabels){d=d+": "+currentvalue;d+=this.options.vertical_label_unit?" "+this.options.vertical_label_unit:""}else{d=currentvalue.toString();d+=this.options.vertical_label_unit?" "+this.options.vertical_label_unit:""}var j=this.paper.set(),textpadding=4,text=this.paper.text(circle.attrs.cx,circle.attrs.cy-(this.options.font_size*1.5)-2*textpadding,d);text.attr({'font-size':this.options.font_size,fill:this.options.background_colour,opacity:1});var k=text.getBBox(),roundRect=this.paper.rect(text.attrs.x-(k.width/2)-textpadding,text.attrs.y-(k.height/2)-textpadding,k.width+(textpadding*2),k.height+(textpadding*2),textpadding*1.5);roundRect.attr({fill:this.options.label_colour,opacity:1});var l=this.paper.path();l.attr({fill:this.options.label_colour,opacity:1});l.moveTo(text.attrs.x-textpadding,text.attrs.y+(k.height/2)+textpadding+0.5);l.lineTo(text.attrs.x,text.attrs.y+(k.height/2)+(2*textpadding+0.5));l.lineTo(text.attrs.x+textpadding,text.attrs.y+(k.height/2)+textpadding+0.5);l.andClose();text.toFront();j.push(circle,roundRect,l,text).attr({opacity:0}).toFront();this.checkHoverPos({rect:roundRect,set:j,marker:circle,nib:l,textpadding:textpadding});this.globalHoverSet.push(j);this.globalBlockSet.push(block);block.node.onmouseover=function(e){j.animate({opacity:1},200)};block.node.onmouseout=function(e){j.animate({opacity:0},200)}}},drawPlot:function(a,b,x,y,c,d,e,f,g){if(this.options.markers==='circle'){this.drawGraphMarkers(a,x,y,c,e,f)}else if(this.options.markers==='value'){this.drawGraphValueMarkers(a,x,y,c,e,f,g)}if(a===0){return this.startPlot(b,x,y,c)}if(this.options.curve_amount){b.cplineTo(x,y,this.options.curve_amount)}else{b.lineTo(x,y)}}});Ico.AreaGraph=Class.create(Ico.LineGraph,{chartDefaults:function(){return{plot_padding:10,area:true}},setChartSpecificOptions:function(){if(typeof this.options.curve_amount==='undefined'){this.options.curve_amount=10}},drawPlot:function(a,b,x,y,c,d,e,f,g){var h=this.options.area||this.options.stacked_fill;if(this.options.markers==='circle'){if(h===true){if(a!==0&&a!==d.length-1){this.drawGraphMarkers(a,b,x,y,c,e,f)}}else{this.drawGraphMarkers(a,b,x,y,c,e,f)}}else if(this.options.markers==='value'){this.drawGraphValueMarkers(a,x,y,c,e,f,g)}if(a===0){return this.startPlot(b,x,y,c)}if(this.options.curve_amount&&a>1&&(a<d.length-1)){b.cplineTo(x,y,this.options.curve_amount)}else if(this.options.curve_amount&&!h&&(a=1||(a=d.length-1))){b.cplineTo(x,y,this.options.curve_amount)}else{b.lineTo(x,y)}}});Ico.StackGraph=Class.create(Ico.AreaGraph,{chartDefaults:function(){return{plot_padding:10,stacked_fill:true,stacked:true}},normaliserOptions:function(){},stackData:function(b){this.stacked_data=b.collect(function(a){return a[1]});this.stacked_data.reverse();for(var i=1;i<this.stacked_data.length;i++){for(var j=0;j<this.stacked_data[0].length;j++){this.stacked_data[i][j]+=this.stacked_data[i-1][j]}}this.stacked_data.reverse();return this.stacked_data}});Ico.BarGraph=Class.create(Ico.BaseGraph,{chartDefaults:function(){return{plot_padding:0}},normaliserOptions:function(){return{start_value:0}},setChartSpecificOptions:function(){this.bar_padding=5;this.bar_width=this.calculateBarWidth();this.options.plot_padding=(this.bar_width/2);this.step=this.calculateStep();this.grid_start_offset=this.bar_padding-1},calculateBarWidth:function(){return(this.graph_width/this.data_size)-this.bar_padding},calculateStep:function(){return(this.graph_width-(this.options.plot_padding*2)-(this.bar_padding*2))/(this.data_size-1)},drawPlot:function(a,b,x,y,c,d,f,g){var h=this.options.height-this.y_padding_bottom,lastcolor=this.options.bargraph_lastcolour,colour2;x=x+this.bar_padding;if(lastcolor&&a===d.length-1){colour2=lastcolor}else{colour2=c}var i=this.paper.rect(x-(this.bar_width/2),h-(this.options.height-y-this.y_padding_bottom),this.bar_width,(this.options.height-this.y_padding_bottom)-y);i.attr({fill:colour2,'stroke-width':0,stroke:colour2});if(this.options.datalabels){var j=this.options.hover_colour||c,hoverSet=this.paper.set(),text,hoverbar=this.paper.rect(x-(this.bar_width/2),this.y_padding_top,this.bar_width,this.options.height);f=f[a].toString();text=this.paper.text(i.attrs.x+(this.bar_width/2),i.attrs.y-(this.options.font_size*1.5),f),hoverbar.attr({fill:colour2,'stroke-width':0,stroke:colour2,opacity:0});text.attr({'font-size':this.options.font_size,fill:this.options.background_colour,opacity:1});var k=text.getBBox(),textpadding=4,roundRect=this.paper.rect(text.attrs.x-(k.width/2)-textpadding,text.attrs.y-(k.height/2)-textpadding,k.width+(textpadding*2),k.height+(textpadding*2),textpadding*1.5);roundRect.attr({fill:this.options.label_colour,opacity:1});var l=this.paper.path();l.attr({fill:this.options.label_colour,opacity:1});l.moveTo(hoverbar.attrs.x+(this.bar_width/2)-textpadding,text.attrs.y+(k.height/2)+textpadding+0.5);l.lineTo(hoverbar.attrs.x+(this.bar_width/2),text.attrs.y+(k.height/2)+(textpadding*2)+0.5);l.lineTo(hoverbar.attrs.x+(this.bar_width/2)+textpadding,text.attrs.y+(k.height/2)+textpadding+0.5);l.andClose();text.toFront();hoverSet.push(roundRect,l,text).attr({opacity:0}).toFront();hoverbar.toFront();this.checkHoverPos({rect:roundRect,set:hoverSet,nib:l});this.globalHoverSet.push(hoverSet);if(roundRect.attrs.y<0){hoverSet.translate(0,1+(roundRect.attrs.y*-1))}hoverbar.node.onmouseover=function(e){i.animate({fill:j,stroke:j},200);hoverSet.animate({opacity:1},200)}.bind(this);hoverbar.node.onmouseout=function(e){i.animate({fill:colour2,stroke:colour2},200);hoverSet.animate({opacity:0},200)}}x=x+this.step;this.options.count++},drawHorizontalLabels:function(){var a=this.bar_padding+this.options.plot_padding;this.drawMarkers(this.options.labels,[1,0],this.step,a,[0,(this.options.font_size+7)*-1])}});Ico.HorizontalBarGraph=Class.create(Ico.BarGraph,{setChartSpecificOptions:function(){this.x_padding_left=20+this.longestLabel()*(this.options.font_size/2);this.bar_padding=5;this.bar_width=this.calculateBarHeight();this.options.plot_padding=0;this.step=this.calculateStep();this.options.horizontalbar_grid=true;this.options.horizontalbar_padding=true;this.graph_width=this.options.width-this.x_padding_right-this.x_padding_left},normalise:function(a){var b=this.x_padding_left;return((a/this.range)*(this.graph_width-b))},longestLabel:function(){return $A(this.options.labels).sort(function(a,b){return a.toString().length<b.toString().length}).first().toString().length},calculateBarHeight:function(){return(this.graph_height/this.data_size)-this.bar_padding},calculateStep:function(){return(this.graph_height-(this.options.plot_padding*2))/this.data_size},drawLines:function(e,f,g,h,i){var x=this.x_padding_left+this.options.plot_padding,y=this.y_padding_top+(this.bar_width/2)+(this.bar_padding/2),lastcolor=this.options.bargraph_lastcolour;$A(g).each(function(a,b){var c,horizontal_rounded=this.options.horizontal_rounded?this.bar_width/2:0,cursor=this.paper.rect(x,(y-this.bar_width/2),x+a-this.normalise(this.start_value),this.bar_width,horizontal_rounded);if(lastcolor&&b===$A(g).length-1){c=lastcolor}else{c=f}cursor.attr({fill:c,'stroke-width':0,stroke:c});if(horizontal_rounded){var d=this.paper.rect(x,(y-this.bar_width/2)-0.5,x+a-this.normalise(this.start_value)-this.bar_width/2,this.bar_width+0.5);d.attr({fill:c,'stroke-width':0,stroke:c});cursor.toFront();cursor.secondnode=d}y=y+this.step}.bind(this))},drawFocusHint:function(){var a=5,x=this.x_padding_left+(this.step*2),y=this.options.height-this.y_padding_bottom;var b=this.paper.path().attr({stroke:this.options.label_colour,'stroke-width':2});b.moveTo(x,y);b.lineTo(x-a,y+a);b.moveTo(x-a,y);b.lineTo(x-(a*2),y+a)},drawVerticalLabels:function(){var a=(this.step/2);this.drawMarkers(this.options.labels.reverse(),[0,-1],this.step,a,[-8,-(this.options.font_size/5)],{"text-anchor":'end'})},drawHorizontalLabels:function(){var a=this.graph_width/this.y_label_count,x_labels=this.makeValueLabels(this.y_label_count);if(this.options.vertical_label_unit){for(var i=0;i<x_labels.length;i++){x_labels[i]+=this.options.vertical_label_unit}}this.drawMarkers(x_labels,[1,0],a,a,[0,(this.options.font_size+7)*-1])}});Ico.SparkLine=Class.create(Ico.Base,{initialize:function(a,b,c){this.element=a;this.data=b;this.options={highlight:false};Object.extend(this.options,c||{});this.step=this.calculateStep();this.paper=new Raphael(this.element,this.options.width,this.options.height);if(this.options.acceptable_range){this.background=this.paper.rect(0,this.options.height-this.normalise(this.options.acceptable_range[1]),this.options.width,this.options.height-this.normalise(this.options.acceptable_range[0]))}else{this.background=this.paper.rect(0,0,this.options.width,this.options.height)}this.background.attr({fill:this.options.background_colour,stroke:'none'});this.draw()},calculateStep:function(){return this.options.width/(this.data.length-1)},normalise:function(a){return(this.options.height/this.data.max())*a},draw:function(){var a=this.normaliseData(this.data);this.drawLines('',this.options.colour,a);if(this.options.highlight){this.showHighlight(a)}},drawLines:function(b,c,d){var e=this.paper.path().attr({stroke:c,"stroke-width":this.options.stroke_width}).moveTo(0,this.options.height-d.first()),x=0;d.slice(1).each(function(a){x=x+this.step;e.lineTo(x,this.options.height-a)}.bind(this))},showHighlight:function(a){var b=2,x=this.options.width-b,i=this.options.highlight.index||a.length-1,y=a[i]+(b/2).round(),circle;if(typeof this.options.highlight.index!=='undefined'){x=this.step*this.options.highlight.index}circle=this.paper.circle(x,this.options.height-y,b);circle.attr({stroke:false,fill:this.options.highlight.colour})}});Ico.SparkBar=Class.create(Ico.SparkLine,{calculateStep:function(){return this.options.width/this.data.length},drawLines:function(d,e,f){var g=this.options.bargraph_lastcolour,width=this.step>2?this.step-1:this.step,x=width;f.each(function(a,b){var c,line;if(g&&b===f.length-1){c=g}else{c=e}line=this.paper.path().attr({stroke:c,'stroke-width':width});line.moveTo(x,this.options.height-a);line.lineTo(x,this.options.height);x=x+this.step}.bind(this))}});

