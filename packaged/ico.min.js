var Ico={Base:{},Normaliser:{},SparkLine:{},SparkBar:{},BaseGraph:{},LineGraph:{},AreaGraph:{},StackGraph:{},BarGraph:{},HorizontalBarGraph:{}};Ico.Base=Class.create({normaliseData:function(a){return $A(a).collect(function(b){return this.normalise(b)}.bind(this))},deepCopy:function(a){var b,c,d;if(Object.prototype.toString.call(a)==="[object Array]"){b=[];d=a.length;for(c=0;c<d;c++)b[c]=arguments.callee(a[c]);return b}if(typeof a==="object"){b={};for(c in a)b[c]=arguments.callee(a[c]);return b}return a}});
Ico.Normaliser=Class.create({initialize:function(a,b){this.options={start_value:null};Object.extend(this.options,b||{});this.min=a.min();this.max=a.max();this.standard_deviation=a.standard_deviation();this.range=0;this.step=this.labelStep(this.max-this.min);this.start_value=this.calculateStart();this.process()},calculateStart:function(){var a=this.round(this.options.start_value!==null&&this.min>=0?this.options.start_value:this.min,1);if(this.min>0&&a>this.min)return 0;return a},round:function(a,b){var c=
a;b=b||1;if(this.standard_deviation>0.1){b=Math.pow(10,-b);c=Math.round(a*b)/b;if(c>this.min)return this.round(a-this.step)}return c},process:function(){this.range=this.max-this.start_value;this.step=this.labelStep(this.range);if(this.range/this.step>15)this.step*=3;this.zero_value=(0-this.start_value)/this.step},labelStep:function(a){return Math.pow(10,(Math.log(a)/Math.LN10).round()-1)}});
Ico.BaseGraph=Class.create(Ico.Base,{initialize:function(a,b,c){this.element=a;this.data_sets=Object.isArray(b)?new Hash({one:b}):$H(b);if(this.chartDefaults().stacked===true){this.real_data=this.deepCopy(this.data_sets);this.stackData(this.data_sets)}this.flat_data=this.data_sets.collect(function(d){return d[1]}).flatten();this.normaliser=new Ico.Normaliser(this.flat_data,this.normaliserOptions());this.label_step=this.normaliser.step;this.range=this.normaliser.range;this.start_value=this.normaliser.start_value;
this.zero_value=this.normaliser.zero_value;this.data_size=this.longestDataSetLength();if(c&&c.colour){c.colours={};this.data_sets.keys().each(function(d){c.colours[d]=c.colour})}this.options={width:parseInt(a.getStyle("width"),10),height:parseInt(a.getStyle("height"),10),labels:$A($R(1,this.data_size)),grid:true,plot_padding:10,font_size:10,show_horizontal_labels:true,show_vertical_labels:true,vertical_label_unit:"",colours:this.makeRandomColours(),background_colour:a.getStyle("backgroundColor"),
label_colour:"#000",grid_colour:"#ccc",hover_text_colour:"#fff",markers:false,marker_size:5,meanline:false,padding_top:20,draw_axis:true,datalabels:"",hover_colour:"",watermark:false,watermark_location:false,hide_empty_label_grid:false,left_padding:false,label_rotation:0};Object.extend(this.options,this.chartDefaults()||{});Object.extend(this.options,c||{});this.x_padding_left=10+this.paddingLeftOffset();this.x_padding_left+=this.options.vertical_label_unit?6:0;this.x_padding_left=this.options.left_padding?
this.options.left_padding:this.x_padding_left;this.x_padding_right=20;this.x_padding=this.x_padding_left+this.x_padding_right;this.y_padding_top=this.options.padding_top;this.y_padding_bottom=20+this.paddingBottomOffset();this.y_padding=this.y_padding_top+this.y_padding_bottom;this.graph_width=this.options.width-this.x_padding;this.graph_height=this.options.height-this.y_padding;this.step=this.calculateStep();this.y_label_count=(this.range/this.label_step).round();if(this.normaliser.min+this.y_label_count*
this.normaliser.step<this.normaliser.max)this.y_label_count+=1;this.value_labels=this.makeValueLabels(this.y_label_count);this.top_value=this.value_labels.last();this.grid_start_offset=-1;this.paper=new Raphael(this.element,this.options.width,this.options.height);this.background=this.paper.rect(this.x_padding_left,this.y_padding_top,this.graph_width,this.graph_height);this.background.attr({fill:this.options.background_colour,stroke:"none"});this.options.meanline=this.options.meanline===true?{"stroke-width":"2px",
stroke:"#BBBBBB"}:this.options.meanline;this.globalMarkerSet=this.paper.set();this.globalHoverSet=this.paper.set();this.globalBlockSet=this.paper.set();this.globalAreaLineSet=this.paper.set();this.setChartSpecificOptions();this.draw();this.globalAreaLineSet.toFront();this.globalMarkerSet.toFront();this.globalHoverSet.toFront();this.globalBlockSet.toFront()},normaliserOptions:function(){return{graph_height:parseInt(this.element.getStyle("height"),10)}},chartDefaults:function(){},drawPlot:function(){},
calculateStep:function(){},getMousePos:function(a){var b=0,c=0;if(!a)a=window.event;if(a.pageX||a.pageY){b=a.pageX;c=a.pageY}else if(a.clientX||a.clientY){b=a.clientX+document.body.scrollLeft-document.documentElement.scrollLeft;c=a.clientY+document.body.scrollTop-document.documentElement.scrollTop}return{x:b,y:c}},makeRandomColours:function(){var a={};this.data_sets.each(function(b){a[b[0]]=Raphael.hsb2rgb(Math.random(),1,0.75).hex});return a},longestDataSetLength:function(){var a=0;this.data_sets.each(function(b){a=
b[1].length>a?b[1].length:a});return a},roundValue:function(a,b){b=Math.pow(10,b);a*=b;return a=Math.round(a)/b},roundValues:function(a,b){return $A(a).collect(function(c){return this.roundValue(c,b)}.bind(this))},paddingLeftOffset:function(){if(this.options.show_vertical_labels){var a=this.flat_data;a=this.roundValues(a,2);a=$A(a).sort(function(b,c){return b.toString().length<c.toString().length}).first().toString().length;a=a>2?a-1:a;return a*this.options.font_size}else return 0},paddingBottomOffset:function(){return this.options.font_size},
normalise:function(a){return a/(this.start_value===0?this.top_value:this.range)*this.graph_height},draw:function(){this.options.grid&&this.drawGrid();this.options.watermark&&this.drawWatermark();this.options.show_vertical_labels&&this.drawVerticalLabels();this.options.show_horizontal_labels&&this.drawHorizontalLabels();this.options.watermark||this.drawLinesInit(this);this.options.draw_axis&&this.drawAxis();this.start_value!==0&&this.drawFocusHint();this.options.meanline&&this.drawMeanLine(this.normaliseData(this.flat_data))},
drawLinesInit:function(a){a.data_sets.each(function(b,c){a.drawLines(b[0],a.options.colours[b[0]],a.normaliseData(b[1]),a.options.datalabels[b[0]],a.element,c)}.bind(a))},drawWatermark:function(){var a=this.options.watermark,b=new Image,c=this;b.onload=function(){var d,e;if(c.options.watermark_location==="middle"){d=(c.graph_width-b.width)/2+c.x_padding_left;e=(c.graph_height-b.height)/2+c.y_padding_top}else{d=c.graph_width-b.width+c.x_padding_left-2;e=c.graph_height-b.height+c.y_padding_top-2}d=
c.paper.image(b.src,d,e,b.width,b.height).attr({opacity:"0.4"});c.drawLinesInit(c,c.data);if(c.options.stacked_fill||c.options.area)d.toFront()};b.src=a.src||a},drawGrid:function(){var a=this.paper.path().attr({stroke:this.options.grid_colour}),b,c;b=this.graph_height+this.y_padding_top;for(var d=0;d<this.y_label_count+1;d++){a.moveTo(this.x_padding_left-0.5,parseInt(b,10)+0.5);a.lineTo(this.x_padding_left+this.graph_width-0.5,parseInt(b,10)+0.5);b-=this.graph_height/this.y_label_count}b=this.x_padding_left+
this.options.plot_padding+this.grid_start_offset;c=this.options.labels.length;for(d=0;d<c;d++){if(this.options.hide_empty_label_grid===true&&this.options.labels[d]!==""||this.options.hide_empty_label_grid===false){a.moveTo(parseInt(b,10),this.y_padding_top);a.lineTo(parseInt(b,10),this.y_padding_top+this.graph_height)}b+=this.step}},drawLines:function(a,b,c,d,e,g){var f=this.calculateCoords(c),h=this.graph_height+this.y_padding_top,j,i,k;if(this.options.start_at_zero===false){k=0;$A(f).each(function(l){l[1]===
h&&k++});this.options.odd_horizontal_offset=k;this.options.odd_horizontal_offset>1&&f.splice(0,this.options.odd_horizontal_offset)}if(this.options.stacked_fill||this.options.area){if(this.options.area){a=this.options.area_opacity?this.options.area_opacity:1.5/this.data_sets.collect(function(l){return l.length}).length;j=this.paper.path().attr({stroke:b,fill:b,"stroke-width":"0",opacity:a,"stroke-opacity":0})}else j=this.paper.path().attr({stroke:b,fill:b,"stroke-width":"0"});f.unshift([f[0][0],h]);
f.push([f[f.length-1][0],h])}else j=this.paper.path().attr({stroke:b,"stroke-width":this.options.stroke_width+"px"});this.options.datalabels&&this.drawHover(j,d,e,b);$A(f).each(function(l,m){this.drawPlot(m,j,l[0],l[1],b,f,d,e,g)}.bind(this));if(this.options.area){i=this.paper.path().attr({stroke:b,"stroke-width":this.options.stroke_width+"px"});f.remove(0);f.remove(-1);$A(f).each(function(l,m){this.drawPlot(m,i,l[0],l[1],b,f,d,e,g,true)}.bind(this));this.globalAreaLineSet.push(i)}},calculateCoords:function(a){var b=
this.x_padding_left+this.options.plot_padding-this.step,c=this.graph_height+this.y_padding_top+this.normalise(this.start_value);return $A(a).collect(function(d){d=c-d;b+=this.step;return[b,d]}.bind(this))},drawFocusHint:function(){var a=this.x_padding_left+2.5-1,b=this.options.height-this.y_padding_bottom,c=this.paper.path().attr({stroke:this.options.label_colour,"stroke-width":2});c.moveTo(a,b);c.lineTo(a-5,b-5);c.moveTo(a,b-5);c.lineTo(a-5,b-10)},drawMeanLine:function(a){var b=this.paper.path().attr(this.options.meanline);
a=$A(a).inject(0,function(c,d){return d+c})/a.length-0.5;a=this.options.bar?a+this.zero_value*(this.graph_height/this.y_label_count):a;b.moveTo(this.x_padding_left-1,this.options.height-this.y_padding_bottom-a);b.lineTo(this.graph_width+this.x_padding_left,this.options.height-this.y_padding_bottom-a)},drawAxis:function(){var a=this.paper.path().attr({stroke:this.options.label_colour});a.moveTo(parseInt(this.x_padding_left,10)-0.5,this.options.height-parseInt(this.y_padding_bottom,10)+0.5);a.lineTo(parseInt(this.graph_width+
this.x_padding_left,10)-0.5,this.options.height-parseInt(this.y_padding_bottom,10)+0.5);a.moveTo(parseInt(this.x_padding_left,10)-0.5,parseInt(this.options.height-this.y_padding_bottom,10)+0.5);a.lineTo(parseInt(this.x_padding_left,10)-0.5,parseInt(this.y_padding_top,10))},makeValueLabels:function(a){for(var b=this.label_step,c=this.start_value,d=[],e=0;e<a;e++){c=this.roundValue(c+b,3);d.push(c)}return d},drawMarkers:function(a,b,c,d,e,g){function f(m){return m*b[0]}function h(m){return m*b[1]}var j=
parseInt(this.x_padding_left,10)-0.5+f(d),i=this.options.height-this.y_padding_bottom+h(d),k=this.paper.path().attr({stroke:this.options.label_colour}),l={font:this.options.font_size+'px "Arial"',stroke:"none",fill:this.options.label_colour};Object.extend(l,g||{});a.each(function(m){if(this.options.draw_axis&&(this.options.hide_empty_label_grid===true&&m!==""||this.options.hide_empty_label_grid===false)){k.moveTo(parseInt(j,10),parseInt(i,10)+0.5);k.lineTo(parseInt(j,10)+h(5),parseInt(i,10)+0.5+f(5))}this.paper.text(j+
e[0],i-2-e[1],m.toString()).attr(l).toFront();j+=f(c);i+=h(c)}.bind(this))},drawVerticalLabels:function(){for(var a=this.graph_height/this.y_label_count,b=this.options.vertical_label_unit?" "+this.options.vertical_label_unit:"",c=0;c<this.value_labels.length;c++)this.value_labels[c]+=b;this.drawMarkers(this.value_labels,[0,-1],a,a,[-8,-2],{"text-anchor":"end"})},drawHorizontalLabels:function(){this.drawMarkers(this.options.labels,[1,0],this.step,this.options.plot_padding,[0,(this.options.font_size+
7)*-1],this.options.label_rotation?{rotation:this.options.label_rotation,translation:-this.options.font_size+" 0"}:{})},drawHover:function(a,b,c,d){var e=this.options.stacked_fill||this.options.area?"fill":"stroke",g=this.options.hover_colour||d,f=this.paper.set();b=this.paper.text(a.attrs.x,a.attrs.y-this.options.font_size*1.5-4,b);var h;b.attr({"font-size":this.options.font_size,fill:this.options.hover_text_colour,opacity:1});h=b.getBBox();roundRect=this.paper.rect(b.attrs.x-h.width/2-4,b.attrs.y-
h.height/2-4,h.width+8,h.height+8,6).attr({fill:this.options.label_colour,opacity:1,stroke:0,"stroke-color":this.options.label_colour});b.toFront();f.push(roundRect,b).attr({opacity:0}).toFront();this.checkHoverPos({rect:roundRect,set:f});this.globalHoverSet.push(f);a.node.onmouseover=function(j){e==="fill"?a.animate({fill:g,stroke:g},200):a.animate({stroke:g},200);j=this.getMousePos(j);f[0].attr({x:j.x-h.width/2-4-c.offsetLeft,y:j.y-h.height/2-this.options.font_size*1.5-4-c.offsetTop,opacity:1});
f[1].attr({x:j.x-c.offsetLeft,y:j.y-this.options.font_size*1.5-c.offsetTop,opacity:1});a.node.onmousemove=function(i){i=this.getMousePos(i);f[0].attr({x:i.x-h.width/2-4-c.offsetLeft,y:i.y-h.height/2-this.options.font_size*1.5-4-c.offsetTop,opacity:1});f[1].attr({x:i.x-c.offsetLeft,y:i.y-this.options.font_size*1.5-c.offsetTop,opacity:1});this.checkHoverPos(roundRect,f)}.bind(this)}.bind(this);a.node.onmouseout=function(){e==="fill"?a.animate({fill:d,stroke:d},200):a.animate({stroke:d},200);f.attr({opacity:0})}},
checkHoverPos:function(a){var b,c,d,e,g,f;if(a.rect){b=a.rect;c=b.getBBox()}if(a.set)d=a.set;if(a.marker)e=a.marker;if(a.nib)g=a.nib;if(a.textpadding)f=a.textpadding;if(b&&d){if(b.attrs.y<0)if(g&&e){d.translate(0,d.getBBox().height+f*2);e.translate(0,-d.getBBox().height-f*2);g.translate(0,-c.height-f+1).scale(1,-1)}else{a=b.attrs.y;d.translate(0,1+a*-1)}if(b.attrs.y+c.height>this.options.height){a=b.attrs.y+c.height-this.options.height;d.translate(0,a*-1-1);e&&e.translate(0,a+1)}if(b.attrs.x<0){a=
b.attrs.x;d.translate(a*-1+1,0);g&&g.translate(a-1,0);e&&e.translate(a-1,0)}if(b.attrs.x+c.width>this.options.width){a=b.attrs.x+c.width-this.options.width;d.translate(a*-1-1,0);g&&g.translate(a+1,0);e&&e.translate(a+1,0)}}}});Array.prototype.sum=function(){for(var a=0,b=0;a<this.length;b+=this[a++]);return b};if(typeof Array.prototype.max==="undefined")Array.prototype.max=function(){return Math.max.apply({},this)};
if(typeof Array.prototype.min==="undefined")Array.prototype.min=function(){return Math.min.apply({},this)};Array.prototype.mean=function(){return this.sum()/this.length};Array.prototype.variance=function(){for(var a=this.mean(),b=0,c=0;c<this.length;c++)b+=Math.pow(this[c]-a,2);return b/(this.length-1)};Array.prototype.standard_deviation=function(){return Math.sqrt(this.variance())};
Array.prototype.remove=function(a,b){b=this.slice((b||a)+1||this.length);this.length=a<0?this.length+a:a;return this.push.apply(this,b)};Raphael.el.isAbsolute=true;Raphael.el.absolutely=function(){this.isAbsolute=1;return this};Raphael.el.relatively=function(){this.isAbsolute=0;return this};Raphael.el.moveTo=function(a,b){this._last={x:a,y:b};return this.attr({path:this.attrs.path+["m","M"][+this.isAbsolute]+parseFloat(a)+" "+parseFloat(b)})};
Raphael.el.lineTo=function(a,b){this._last={x:a,y:b};return this.attr({path:this.attrs.path+["l","L"][+this.isAbsolute]+parseFloat(a)+" "+parseFloat(b)})};Raphael.el.cplineTo=function(a,b,c){this.attr({path:this.attrs.path+["C",this._last.x+c,this._last.y,a-c,b,a,b]});this._last={x:a,y:b};return this};Raphael.el.andClose=function(){return this.attr({path:this.attrs.path+"z"})};
Ico.LineGraph=Class.create(Ico.BaseGraph,{chartDefaults:function(){return{line:true,start_at_zero:true,stroke_width:5}},setChartSpecificOptions:function(){if(typeof this.options.curve_amount==="undefined")this.options.curve_amount=10},calculateStep:function(){return(this.graph_width-this.options.plot_padding*2)/(this.data_size-1)},startPlot:function(a,b,c){a.moveTo(b,c)},drawPlot:function(a,b,c,d,e,g,f,h,j){if(this.options.markers==="circle")this.drawGraphMarkers(a,c,d,e,f,h);else this.options.markers===
"value"&&this.drawGraphValueMarkers(a,c,d,e,f,h,j);if(a===0)return this.startPlot(b,c-0.5,d,e);this.options.curve_amount?b.cplineTo(c,d,this.options.curve_amount):b.lineTo(c,d)},drawGraphMarkers:function(a,b,c,d){var e=this.paper.circle(b,c,this.options.marker_size),g=this.options.marker_size,f=this.options.hover_colour||d,h;e.attr({"stroke-width":"1px",stroke:this.options.background_colour,fill:d});this.globalMarkerSet.push(e);e.node.onmouseover=function(){h=parseInt(1.7*g,10);e.animate({r:h,fill:f},
200)}.bind(this);e.node.onmouseout=function(){e.animate({r:g,fill:d},200)}},drawGraphValueMarkers:function(a,b,c,d,e,g,f){if(this.options.odd_horizontal_offset>1)a+=this.options.odd_horizontal_offset;a-=this.options.stacked_fill||this.options.area?1:0;if(g=(this.options.stacked?this.real_data:this.data_sets).collect(function(l){return l[1][a]})[f]){g=""+g.toString().split(".");if(g[1])g[1]=g[1].truncate(3,"")}if(this.options.line||this.options.stacked||(this.options.stacked_fill||this.options.area)&&
a!=-1&&typeof g!="undefined"){f=b-this.step/2;var h=this.options.stacked?c-this.graph_height/18:c-this.graph_height/6,j=this.step,i=this.options.stacked?this.graph_height/9:this.graph_height/3;b=this.paper.circle(b,c,this.options.marker_size);c=this.paper.rect(f,h,j,i);b.attr({"stroke-width":"1px",stroke:this.options.background_colour,fill:d,opacity:0});c.attr({fill:d,"stroke-width":0,stroke:d,opacity:0}).toFront();e=this.options.datalabels?e+": "+g:g.toString();e+=this.options.vertical_label_unit?
" "+this.options.vertical_label_unit:"";var k=this.paper.set();d=this.paper.text(b.attrs.cx,b.attrs.cy-this.options.font_size*1.5-8,e);d.attr({"font-size":this.options.font_size,fill:this.options.hover_text_colour,opacity:1});e=d.getBBox();g=this.paper.rect(d.attrs.x-e.width/2-4,d.attrs.y-e.height/2-4,e.width+8,e.height+8,6);g.attr({fill:this.options.label_colour,opacity:1,stroke:0,"stroke-color":this.options.label_colour});f=this.paper.path();f.attr({fill:this.options.label_colour,opacity:1,stroke:0,
"stroke-color":this.options.label_colour});f.moveTo(d.attrs.x-4,d.attrs.y+e.height/2+4-1.5);f.lineTo(d.attrs.x,d.attrs.y+e.height/2+7.5);f.lineTo(d.attrs.x+4,d.attrs.y+e.height/2+4-1.5);f.andClose();d.toFront();k.push(b,g,f,d).attr({opacity:0}).toFront();this.checkHoverPos({rect:g,set:k,marker:b,nib:f,textpadding:4});this.globalHoverSet.push(k);this.globalBlockSet.push(c);c.node.onmouseover=function(){k.animate({opacity:1},200)};c.node.onmouseout=function(){k.animate({opacity:0},200)}}}});
Ico.AreaGraph=Class.create(Ico.LineGraph,{chartDefaults:function(){return{area:true,area_opacity:false,stroke_width:0}},setChartSpecificOptions:function(){if(typeof this.options.curve_amount==="undefined")this.options.curve_amount=10},drawPlot:function(a,b,c,d,e,g,f,h,j,i){var k=this.options.area||this.options.stacked_fill;if(!i)if(k===true){if(a!==0&&a!==g.length-1)if(this.options.markers==="circle")this.drawGraphMarkers(a,c,d,e,f,h);else this.options.markers==="value"&&this.drawGraphValueMarkers(a,
c,d,e,f,h,j)}else if(this.options.markers==="circle")this.drawGraphMarkers(a,c,d,e,f,h);else this.options.markers==="value"&&this.drawGraphValueMarkers(a,c,d,e,f,h,j);c-=0.5;if(a===0)return this.startPlot(b,c,d,e);if(this.options.curve_amount&&a>1&&a<g.length-1)b.cplineTo(c,d,this.options.curve_amount);else this.options.curve_amount&&!k&&1?b.cplineTo(c,d,this.options.curve_amount):b.lineTo(c,d)}});
Ico.StackGraph=Class.create(Ico.AreaGraph,{chartDefaults:function(){return{stacked:true,stacked_fill:true,stroke_width:5}},normaliserOptions:function(){},stackData:function(a){this.stacked_data=a.collect(function(c){return c[1]});this.stacked_data.reverse();for(a=1;a<this.stacked_data.length;a++)for(var b=0;b<this.stacked_data[0].length;b++)this.stacked_data[a][b]+=this.stacked_data[a-1][b];this.stacked_data.reverse();return this.stacked_data}});
Ico.BarGraph=Class.create(Ico.BaseGraph,{chartDefaults:function(){return{bar:true,plot_padding:0,bargraph_lastcolour:false,bargraph_negativecolour:false}},normaliserOptions:function(){},setChartSpecificOptions:function(){this.bar_padding=5;this.bar_width=this.calculateBarWidth();this.options.plot_padding=this.bar_width/2;this.step=this.calculateStep();this.grid_start_offset=this.bar_padding-1},calculateBarWidth:function(){return this.graph_width/this.data_size-this.bar_padding},calculateStep:function(){return(this.graph_width-
this.options.plot_padding*2-this.bar_padding*2)/(this.data_size-1)},drawPlot:function(a,b,c,d,e,g,f){b=this.options.height-this.y_padding_bottom-this.zero_value*(this.graph_height/this.y_label_count);var h=this.options.bargraph_lastcolour,j=this.options.bargraph_negativecolour;c+=this.bar_padding;d=this.options.height-this.y_padding_bottom-d-this.zero_value*(this.graph_height/this.y_label_count);e=h&&a===g.length-1?h:d<0?j:e;g=this.paper.rect(c-this.bar_width/2,b,this.bar_width,d);g.attr({fill:e,
"stroke-width":0,stroke:e});d<0?g.attr({height:-g.attrs.height}):g.translate(0,-d);this.options.datalabels&&this.drawGraphValueMarkers(c,a,g,f,e);this.options.count++},drawHorizontalLabels:function(){this.drawMarkers(this.options.labels,[1,0],this.step,this.bar_padding+this.options.plot_padding,[0,(this.options.font_size+7)*-1],this.options.label_rotation?{rotation:this.options.label_rotation,translation:-this.options.font_size+" 0"}:{})},drawGrid:function(){var a=this.paper.path().attr({stroke:this.options.grid_colour}),
b,c,d;b=this.graph_height+this.y_padding_top;if(this.options.horizontalbar){a.moveTo(this.x_padding_left-0.5,parseInt(b,10)+0.5);a.lineTo(this.x_padding_left+this.graph_width-0.5,parseInt(b,10)+0.5);b-=this.graph_height;a.moveTo(this.x_padding_left-0.5,parseInt(b,10)+0.5);a.lineTo(this.x_padding_left+this.graph_width-0.5,parseInt(b,10)+0.5)}else for(var e=0;e<this.y_label_count+1;e++){a.moveTo(this.x_padding_left-0.5,parseInt(b,10)+0.5);a.lineTo(this.x_padding_left+this.graph_width-0.5,parseInt(b,
10)+0.5);b-=this.graph_height/this.y_label_count}if(this.options.horizontalbar){b=this.x_padding_left+this.options.plot_padding+this.grid_start_offset;c=this.y_label_count;d=this.options.horizontalbar?this.graph_width/this.y_label_count:this.step;for(e=0;e<c;e++){if(this.options.hide_empty_label_grid===true&&this.options.labels[e]!==""||this.options.hide_empty_label_grid===false){a.moveTo(parseInt(b,10),this.y_padding_top);a.lineTo(parseInt(b,10),this.y_padding_top+this.graph_height)}b+=d}}a.moveTo(parseInt(this.x_padding_left,
10)-0.5,this.y_padding_top);a.lineTo(parseInt(this.x_padding_left,10)-0.5,this.y_padding_top+this.graph_height);a.moveTo(parseInt(this.x_padding_left+this.graph_width,10)-0.5,this.y_padding_top);a.lineTo(parseInt(this.x_padding_left+this.graph_width,10)-0.5,this.y_padding_top+this.graph_height)},drawGraphValueMarkers:function(a,b,c,d,e){var g=this.options.hover_colour||e,f=this.paper.set();a=this.paper.rect(a-this.bar_width/2,this.y_padding_top,this.bar_width,this.options.height);d=d[b].toString();
b=this.paper.text(c.attrs.x+this.bar_width/2,c.attrs.y-this.options.font_size*1.5,d);a.attr({fill:e,"stroke-width":0,stroke:e,opacity:0});b.attr({"font-size":this.options.font_size,fill:this.options.hover_text_colour,opacity:1});d=b.getBBox();var h=this.paper.rect(b.attrs.x-d.width/2-4,b.attrs.y-d.height/2-4,d.width+8,d.height+8,6);h.attr({fill:this.options.label_colour,opacity:1});var j=this.paper.path();j.attr({fill:this.options.label_colour,opacity:1});j.moveTo(a.attrs.x+this.bar_width/2-4,b.attrs.y+
d.height/2+4+0.5);j.lineTo(a.attrs.x+this.bar_width/2,b.attrs.y+d.height/2+8+0.5);j.lineTo(a.attrs.x+this.bar_width/2+4,b.attrs.y+d.height/2+4+0.5);j.andClose();b.toFront();f.push(h,j,b).attr({opacity:0}).toFront();a.toFront();this.checkHoverPos({rect:h,set:f,nib:j});this.globalHoverSet.push(f);this.globalBlockSet.push(a);h.attrs.y<0&&f.translate(0,1+h.attrs.y*-1);a.node.onmouseover=function(){c.animate({fill:g,stroke:g},200);f.animate({opacity:1},200)}.bind(this);a.node.onmouseout=function(){c.animate({fill:e,
stroke:e},200);f.animate({opacity:0},200)}}});
Ico.HorizontalBarGraph=Class.create(Ico.BarGraph,{chartDefaults:function(){return{bar:true,horizontalbar:true,plot_padding:0,horizontal_rounded:false,bargraph_lastcolour:false}},setChartSpecificOptions:function(){this.x_padding_left=20+this.longestLabel()*(this.options.font_size/2);this.bar_padding=5;this.bar_width=this.calculateBarHeight();this.step=this.calculateStep();this.graph_width=this.options.width-this.x_padding_right-this.x_padding_left},normalise:function(a){var b=this.makeValueLabels(this.y_label_count);
b=b[b.length-1];return a/b*this.graph_width},longestLabel:function(){return $A(this.options.labels).sort(function(a,b){return a.toString().length<b.toString().length}).first().toString().length},calculateBarHeight:function(){return this.graph_height/this.data_size-this.bar_padding},calculateStep:function(){return(this.graph_height-this.options.plot_padding*2)/this.data_size},drawLines:function(a,b,c,d){var e=this.y_padding_top+this.bar_padding/2-0.5,g=this.zero_value*(this.graph_width/this.y_label_count),
f=this.x_padding_left+g-0.5,h=this.options.bargraph_lastcolour,j=this.options.bargraph_negativecolour;this.datalabel=d;$A(c).each(function(i,k){var l;i=i/this.graph_width*(this.graph_width-g);horizontal_rounded=this.options.horizontal_rounded?this.bar_width/2:0;bargraph=this.paper.rect(f,e,i,this.bar_width,horizontal_rounded);l=h&&k===c.length-1?h:i<0?j:b;bargraph.attr({fill:l,"stroke-width":0,stroke:l});i<0&&bargraph.attr({width:-bargraph.attrs.width}).translate(i,0);if(horizontal_rounded){var m=
this.paper.set();bargraph2=this.paper.rect(f,e,i-this.bar_width/2,this.bar_width);bargraph2.attr({fill:l,"stroke-width":0,stroke:l});bargraph.toFront();m.push(bargraph2,bargraph);i<0&&bargraph2.attr({width:-bargraph2.attrs.width-this.bar_width}).translate(i+this.bar_width/2,0)}if(this.options.datalabels){var r=this.options.hover_colour||l,o=this.paper.set(),p=this.paper.rect(this.x_padding_left,e,this.graph_width,this.bar_width);d=this.datalabel[k].toString();k=this.paper.text(g+i+this.x_padding_left/
2,bargraph.attrs.y-this.options.font_size*1.5,d);p.attr({fill:l,"stroke-width":0,stroke:l,opacity:0});k.attr({"font-size":this.options.font_size,fill:this.options.hover_text_colour,opacity:1});i<0&&k.translate(k.getBBox().width,0);i=k.getBBox();var q=this.paper.rect(k.attrs.x-i.width/2-4,k.attrs.y-i.height/2-4,i.width+8,i.height+8,6);q.attr({fill:this.options.label_colour,opacity:1});var n=this.paper.path();n.attr({fill:this.options.label_colour,opacity:1});n.moveTo(k.attrs.x-4,k.attrs.y+i.height/
2+4+0.5);n.lineTo(k.attrs.x,k.attrs.y+i.height/2+8+0.5);n.lineTo(k.attrs.x+4,k.attrs.y+i.height/2+4+0.5);n.andClose();k.toFront();o.push(q,n,k).attr({opacity:0}).toFront();p.toFront();this.checkHoverPos({rect:q,set:o,nib:n});this.globalHoverSet.push(o);this.globalBlockSet.push(p);q.attrs.y<0&&o.translate(0,1+q.attrs.y*-1);p.node.onmouseover=function(){m.animate({fill:r,stroke:r},200);o.animate({opacity:1},200)}.bind(this);p.node.onmouseout=function(){m.animate({fill:l,stroke:l},200);o.animate({opacity:0},
200)}}e+=this.step}.bind(this))},drawFocusHint:function(){var a=this.x_padding_left+10,b=this.options.height-this.y_padding_bottom-2.5,c=this.paper.path().attr({stroke:this.options.label_colour,"stroke-width":2});c.moveTo(a,b);c.lineTo(a-5,b+5);c.moveTo(a-5,b);c.lineTo(a-10,b+5)},drawVerticalLabels:function(){var a=this.step/2,b=this.options.label_rotation?{"text-anchor":"end",rotation:this.options.label_rotation,translation:"0 "+this.options.font_size/2}:{"text-anchor":"end"};this.drawMarkers(this.options.labels.reverse(),
[0,-1],this.step,a,[-8,-(this.options.font_size/5)],b)},drawHorizontalLabels:function(){var a=this.graph_width/this.y_label_count,b=this.makeValueLabels(this.y_label_count);if(this.options.vertical_label_unit)for(var c=0;c<b.length;c++)b[c]+=this.options.vertical_label_unit;this.drawMarkers(b,[1,0],a,a,[0,(this.options.font_size+7)*-1])},drawMeanLine:function(a){var b=this.paper.path().attr(this.options.meanline);a=$A(a).inject(0,function(c,d){return d+c})/a.length;a=this.options.bar?a+this.zero_value*
(this.graph_height/this.y_label_count):a;b.moveTo(this.x_padding_left-1+a,this.y_padding_top);b.lineTo(this.x_padding_left-1+a,this.y_padding_top+this.graph_height)}});
Ico.SparkLine=Class.create(Ico.Base,{initialize:function(a,b,c){this.element=a;this.data=b;this.options={highlight:false,stroke_width:1,colour:this.makeRandomColour(),width:parseInt(a.getStyle("width"),10),height:parseInt(a.getStyle("height"),10),acceptable_range:false,zeroline:false};Object.extend(this.options,c||{});this.step=this.calculateStep();this.paper=new Raphael(this.element,this.options.width,this.options.height);this.background=this.options.acceptable_range?this.paper.rect(0,this.options.height-
this.normalise(this.options.acceptable_range[1]),this.options.width,this.normalise(this.options.acceptable_range[0])):this.paper.rect(0,0,this.options.width,this.options.height);this.background.attr({fill:this.options.background_colour,stroke:"none"});this.draw()},calculateStep:function(){return this.options.width/(this.data.length-1)},makeRandomColour:function(){return Raphael.hsb2rgb(Math.random(),1,0.75).hex},normalise:function(a){if(this.data.min()<0)a-=this.data.min();return this.options.height/
(this.data.max()-this.data.min())*a},draw:function(){var a=this.normaliseData(this.data),b;if(this.options.zeroline&&this.data.min()<0){this.options.zeroline=this.options.zeroline===true?{"stroke-width":"1px",stroke:"#BBBBBB"}:this.options.zeroline;b=parseInt(this.options.height-this.normalise(0));this.paper.path().attr(this.options.zeroline).moveTo(0,b).lineTo(this.options.width,b)}this.drawLines("",this.options.colour,a);this.options.highlight&&this.showHighlight(a)},drawLines:function(a,b,c){var d=
this.paper.path().attr({stroke:b,"stroke-width":this.options.stroke_width}).moveTo(0,this.options.height-c.first()),e=0,g=this.data.min()<0?this.options.stroke_width:0;c.slice(1).each(function(f){e+=this.step;d.lineTo(e,this.options.height-f-g)}.bind(this))},showHighlight:function(a){var b=1+this.options.stroke_width/2,c=this.options.width-b;a=a[this.options.highlight.index||a.length-1]+(b/2).round();var d=this.options.highlight.colour||"#f00";if(typeof this.options.highlight.index!=="undefined")c=
this.step*this.options.highlight.index;this.paper.circle(c,this.options.height-a+b/2,b).attr({stroke:false,fill:d})}});
Ico.SparkBar=Class.create(Ico.SparkLine,{calculateStep:function(){return this.options.width/this.data.length},drawLines:function(a,b,c){var d=this.options.bargraph_lastcolour,e=this.step>2?this.step-1:this.step,g=e/2,f=this.normalise(0);c.each(function(h,j){var i;j=d&&j===c.length-1?d:b;i=this.paper.path().attr({stroke:j,"stroke-width":e});i.moveTo(g,this.options.height-h);i.lineTo(g,this.options.height-f);if(h<f)i.attr({stroke:this.options.bargraph_negativecolour||j});g+=this.step}.bind(this))},
showHighlight:function(){}});
Ico.SparkArea=Class.create(Ico.SparkLine,{drawLines:function(a,b,c){var d=a=b,e=0.2,g=this.normalise(0);if(typeof b=="object"){a=b[1];d=b[0];e=1}var f=this.paper.path().attr({fill:a,stroke:a,"stroke-width":0,"stroke-opacity":0,opacity:e}).moveTo(0,this.options.height-g).lineTo(0,this.options.height-c.first()),h=this.paper.path().attr({stroke:d,"stroke-width":this.options.stroke_width}).moveTo(0,this.options.height-c.first()),j=0;c.slice(1).each(function(i){j+=this.step;f.lineTo(j,this.options.height-
i);h.lineTo(j,this.options.height-i)}.bind(this));f.lineTo(j,this.options.height-g)}});